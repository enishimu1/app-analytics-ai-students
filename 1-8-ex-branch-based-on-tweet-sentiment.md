# 演習 - ツイートの感情に基づいて分岐する

[< Previous Challenge](https://learn.microsoft.com/training/modules/route-and-process-data-logic-apps/7-alter-control-flow-using-control-action) - **[Home](./README.md)** - [Next Challenge >](https://learn.microsoft.com/training/modules/route-and-process-data-logic-apps/9-summary)

この演習では、引き続きソーシャル メディア監視アプリで作業を行います。 ツイートの感情に基づいて分岐するコントロール アクションを追加します。 次の図は、作業を行う部分が強調表示された、アプリの概念図を示しています。

## SQL Server データベースを作成して、肯定的なツイートを格納する
肯定的なツイートを受信したときに、それをバックエンド データベースに保存します。 このセクションでは、スクリプトを実行して、サンドボックス内で使用するためのデータベースを作成します。 コストは発生しません。データベースはサンドボックスで実行されるため、この演習の目的では無料です。

1. [Azure portal](https://portal.azure.com/) にサインインします。
1. 右側の Cloud Shell で、次の curl コマンドを実行して、GitHub から setup-sql-database.sh スクリプトをコピーします。

    ```bash
    curl https://raw.githubusercontent.com/nohanaga/app-analytics-ai-students/main/scripts/setup-sql-database.sh > setup-sql-database.sh
    ```

1. 次のコマンドを実行して、スクリプトを実行します。**[Resource Group]** の部分を既存のリソースグループ名で置き換えます。 このコマンドは数分かかります。

    ```bash
    bash setup-sql-database.sh [Resource Group]
    ```

1. スクリプトが完了するのを待ちます。 完了すると、Cloud Shell には、次のプロパティの値が表示されます。

    - SQL Server サーバー名
    - SQL Server ユーザー名
    - SQL Server パスワード
    - SQL Server データベース名

    Cloud Shell に表示される値を安全な場所に保存します。 これらは、この演習で、Azure portal でアプリを更新するときに必要です。

## 条件 コントロール アクションを作成する
この最初のステップでは、Azure portal で制御アクションをアプリに追加します。 プログラミング用語で、条件をテストする if ステートメントを追加しています。

1. [ロジック アプリ デザイナー] を選択して、ロジック アプリ デザイナーに戻ります。 このボタンは、左側のメニュー ペインの [開発ツール] セクションの下にあります。
1. 既存のセンチメントの検出アクションの下で、[新しいステップ] を選択します。
1. [コネクタとアクションを検索する] 検索ボックスに、 `制御` と入力します。
1. [制御] コネクタを選択します。
1. [アクション] セクションで [条件] を選択します。

## 条件を構成する
条件 コントロール アクションを作成したので、条件を指定する必要があります。 センチメントの検出アクションによって、0 - 1 の数値の "スコア" が返されることを思い出してください。 数値が 0.7 を超える場合は、ツイートを肯定的なものとみなし、それ以外の場合は否定的なものとみなします。

> **注意**
> 新しいバージョンの感情分析では、自動的に positive、negative、および neutral のラベルに分類されるため、スコアの条件によって条件を設定する必要がなくなりました。

1. 条件 アクションで、左端の [値の選択] フィールドを選択します。
1. 動的コンテンツのポップアップで、 `sentiment (ドキュメント)`  を選択します。
1. [次の値に等しい] が現在一覧表示されているドロップダウン リストを展開します。
1. [次の値に等しい] を選択します。
1. 右端の [値の選択] フィールドに `positive` と入力します。
1. [+追加] ボタンをクリックして、行の追加 を選択します。
1. `sentiment (ドキュメント)`、[次の値に等しい]、`neutral` の条件を追加します。
1. 条件を「And」から「または」に変更します。
1. [保存] を選択して作業を保存します。

## SQL Server の行の挿入アクションを見つける
条件 アクションは、`sentiment` が `positive` もしくは `neutral`かどうかを検出するように構成されていますが、その場合の動作を指定していません。 リマインダーとして、SQL Database にツイートの部分を格納します。 これを行うため、SQL Server の行の挿入アクションを見つけましょう。

1. 条件 アクションの If True セクションで、[アクションの追加] を選択します。
1. [コネクタとアクションを検索する] フィールドに、 `SQL Server` と入力します。
1. SQL Server コネクタを選択します。
1. [行を挿入する (V2)] を選択します。

## SQL Server の行の挿入アクションを作成する
SQL Server アクションが見つかったので、それを作成してみましょう。 作成時に、SQL Server データベース名とログイン資格情報も提供します。

1. [接続名] フィールドに、 `SQLConnection` と入力します。
1. [Authentication type] ドロップダウンで `SQL Server Authentication` を選択します。
1. [SQL server name] フィールドに、`[SQL Server サーバー名].database.windows.net` と入力します。
1. [SQL database name] で、`PositiveTweetDatabase` を選択します。これは、スクリプトで作成したデータベースの名前です。
1. [Username] と [Password] フィールドにスクリプトから出力された情報を入力します。
1. [作成] を選択します

## SQL Server の行の挿入アクションを構成する
SQL Server アクションが作成されましたが、ツイート データをデータベースの列にマップする方法を指定する必要があります。 ツイートのテキストを `Content` という列に格納し、ツイートを行った人のユーザー名を `Source` という列に格納しましょう。

1. [サーバー名]に、「Use connection settings (SQL Server サーバー名)」を選択します。
1. [データベース名]に「Use connection settings (PositiveTweetDatabase)」を選択します。
1. [テーブル名]ドロップダウン リストからテーブル `Mentions` を選択します。
1. [新しいパラメーターの追加] ドロップダウン リストから `Content` を選択します。
1. 動的コンテンツのポップアップで、 `ツイート テキスト`  を選択します。

    > **注意**
    > RSS [フィード項目が公開される場合] トリガーを使用している場合は、ここで FeedSummary を使用します。

1. [新しいパラメーターの追加] ドロップダウン リストから `Source` を選択します。
1. 動的コンテンツのポップアップで、[ツイート作成者] を選択します。

    > **注意**
    > RSS [フィード項目が公開される場合] トリガーを使用している場合は、ここで FeedTitle を使用します。

1. [保存] を選択します。

## Outlook の [電子メールを送信する] アクションを見つける
`sentiment` が `positive` もしくは `neutral` の場合、ツイートを SQL Server データベースに追加します。それ以外の `negative` のツイートを受け取ったので、それを電子メールでカスタマー サポートに転送しましょう。 開始するには、Outlook の[電子メールを送信する] アクションを見つける必要があります。

> **注意**
> Outlook.com の電子メール アカウントをお持ちではなく、作成もしない場合は、コネクタの検索フィルターを電子メールの送信に変更して、Gmail や Office 365 Outlook などの別の電子メール プロバイダーを選択できます。

1. 条件 アクションの If False セクションで、[アクションの追加] を選択します。
1. [コネクタとアクションを検索する] フィールドに、 `Outlook` と入力します。
1. [Outlook.com] を選択します。
1. [メールの送信 (V2)] を選択します。

## Outlook の電子メールの送信アクションを構成する
[電子メールを送信する] アクションを見つけたので、ツイート データをそれぞれの電子メール フィールドにマップする必要があります。

1. [サインイン] を選択します。
1. Microsoft アカウントを使用してサインインします。 アカウントがない場合は、ここで作成できます。
1. [はい] を選択して、ロジック アプリに自分の電子メール情報へのアクセスを許可します。
1. [宛先] フィールドに、有効な電子メール アドレスを入力します。 テスト目的で自分のアドレスを使用できます。
1. [件名] フィールドに「検出された否定的なツイート」と入力してから、動的コンテンツのポップアップで、[ツイートの作成者] を選択します。

    > **注意**
    > RSS [フィード項目が公開される場合] トリガーを使用している場合は、ここで FeedTitle を使用します。

1. [本文] フィールドに「ツイートの内容:」と入力してから、動的コンテンツのポップアップで、[新しいツイートが投稿されたら]セクションで[もっと見る]をクリックし、[ツイート テキスト] を選択します。

    > **注意**
    > RSS [フィード項目が公開される場合] トリガーを使用している場合は、ここで FeedSummary を使用します。

1. [保存] を選択します。

## 肯定的な感情のツイートの結果を確認する
これでコントロール アクションが適切に構成され、実行されるようになりました。 SQL Server データベースを調べて、肯定的なツイートを確認してみましょう。

1. Azure portal メニューで、[すべてのリソース] を選択してから、リソースのリストから [PositiveTweetDatabase] を選択します。
1. 左側のメニュー ペインで [クエリ エディター] を選択します。
1. 前のユニットでスクリプトを作成したときに保存したサーバー管理者のログインとパスワードを使用してサインインします。
1. [OK] を選択します。
1. 上部のメニュー バーで [新しいクエリ] を選択します。
1. クエリ エディターで `SELECT * FROM dbo.Mentions` と入力します。
1. [実行] を選択してクエリを実行し、データベースに書き込まれたすべての肯定的なツイートを一覧表示します。


### 次のユニット:[コントロール アクションを使用して制御フローを変更する](https://learn.microsoft.com/training/modules/route-and-process-data-logic-apps/7-alter-control-flow-using-control-action)