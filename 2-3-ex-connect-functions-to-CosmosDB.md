# 演習 - Azure Functions から Azure Cosmos DB に接続するサーバーレスアプリケーションを Visual Studio Code で作成する 

**[Home](./README.md)**

この演習では、Visual Studio Code を使用して、Azure Functions から Azure Cosmos DB に接続するサーバーレスアプリケーションを作成します。 

## ローカル プロジェクトを作成する
このセクションでは、Visual Studio Code を使用して、ローカル Azure Functions プロジェクトを JavaScript で作成します。 

## Azure に関数アプリを作成する
このセクションでは、Azure サブスクリプションに関数アプリと関連リソースを作成します。この作業を進めるには、Azure にサインインしておく必要があります。

1. まだ Azure にサインインしていない場合は、[アクティビティ] バーの Azure アイコンを選択します。 次に、[リソース] 領域で [Azure にサインイン...] を選択します。
　![image](https://user-images.githubusercontent.com/116857296/216564667-2daf4953-e829-4565-bbe6-ff524802d95e.png)
　既にサインインしていて、既存のサブスクリプションを確認できる場合は、次のセクションに進みます。
2. ブラウザーでプロンプトが表示されたらご利用の Azure アカウントを選択し、その Azure アカウントの資格情報を使用してサインインします。
3. 正常にサインインしたら、新しいブラウザー ウィンドウを閉じてかまいません。 ご利用の Azure アカウントに属しているサブスクリプションがサイド バーに表示されます。
4. アクティビティ バーの Azure アイコンを選択します。
5. 次に、[リソース] 領域の + アイコンを選択し、[Create Function App in Azure] (Azure に関数アプリを作成) オプションを選択します。
　![image](https://user-images.githubusercontent.com/116857296/216565933-8c5318ad-a155-44e7-b20b-f8969236bea8.png)
6. プロンプトで、次の情報を入力します。

    |  Prompt  |  [選択]  |
    | ---- | ---- |
    |  **サブスクリプションの選択**  |  ご自分のサブスクリプション（[リソース] に表示されるサブスクリプションが 1 つだけのときは、このプロンプトは表示されません。）  |
    |  **Enter a globally unique name for the function app (関数アプリのグローバルに一意の名前を入力します)**  |  URL パスに有効な名前を入力します。 入力した名前は、Azure Functions 内での一意性を確保するために検証されます。  |
    |  **Select a runtime stack (ランタイム スタックを選択してください)**  |  ローカルで実行している言語バージョンを選択してください。  |
    |  **Select a location for new resources (新しいリソースの場所を選択してください)**  |  東日本リージョンを選択してください。  |
    
    この拡張機能は、Azure に作成されている個々のリソースの状態を [Azure: Activity Log] (Azure: アクティビティ ログ) パネルに表示します。
    ![image](https://user-images.githubusercontent.com/116857296/216568117-02647258-8d40-4932-9254-889f449331bb.png)

7. 作成が完了すると、次の Azure リソースがサブスクリプションに作成されます。 リソースは、関数アプリの名前に基づいて命名されます。
　* リソース グループ。関連リソースの論理コンテナーです。
　* Standard Azure ストレージ アカウント。プロジェクトについての状態とその他の情報を保持します。
　* 関数アプリ。関数コードを実行するための環境となります。 関数アプリを使用すると、同じホスティング プランに含まれるリソースの管理、デプロイ、共有を容易にするための論理ユニットとして関数をグループ化できます。
　* App Service プラン。関数アプリの基になるホストを定義します。
　* 関数アプリに接続された Application Insights インスタンス。アプリ内の関数の使用を追跡します。

　　関数アプリが作成され、展開パッケージが適用されると、通知が表示されます。
  
　> **ヒント**
　> 
　> 既定では、関数アプリに必要な Azure リソースが、指定した関数アプリ名に基づいて作成されます。 また、既定では、関数アプリを含んだ同じ新しいリソース グループがその作成先となります。 それらのリソースの名前をカスタマイズしたり、既存のリソースを再利用したりする場合は、高度な作成オプションを使用してプロジェクトを発行する必要があります。

## Azure Cosmos DB を作成する
このセクションでは、Azure サブスクリプションに Azure Cosmos DB アカウントを作成します。アカウントを作成後、Azure Cosmos DB にデータベースとコンテナーを作成します。この作業を進めるには、Azure にサインインしておく必要があります。

> **重要**
> 
> Azure Cosmos DB サーバーレスは一般公開されました。 この使用量ベースのモードにより、Azure Cosmos DB がサーバーレス ワークロードのための強力なオプションになります。 サーバーレス モードで Azure Cosmos DB を使用するには、アカウントの作成時に、 [Capacity mode](容量モード) として [サーバーレス] を選択します。

1. 左にスクロールし、ロジック アプリのメニューで [概要] を選択します。 ナビゲーション メニューを表示するには、左にスクロールすることが必要な場合があります。または、ブラウザーの検索機能を使用して、ページ上の "概要" という単語を検索することもできます。


## 関数アプリの設定を更新する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## バインディング拡張機能を登録する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## 出力バインディングを追加する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## 出力バインディングを使用するコードを追加する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## 関数をローカルで実行する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## JSON ドキュメントが作成されたことを確認する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

## 更新したアプリを再デプロイして検証する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

----


1. デプロイが完了したら、[リソースに移動] を選択します。 ShoeTracker ロジック アプリの Logic Apps デザイナーが表示されます。
1. 下の [テンプレート] セクションまでスクロールして、[空のロジック アプリ] を選択します。

1. [Azure portal](https://portal.azure.com/) にサインインします。
1. Azure portal のメニューで [リソースの作成] を選択し、上部の検索ボックスで [ロジック アプリ] と入力します。 [ロジック アプリ] ペインが表示されます。
1. ロジック アプリ画面で[作成] ボタンをクリックします。 [ロジック アプリの作成] ペインが表示されます。

## Azure へのサインイン
リソース グループや場所などの基本的な設定を構成しましょう。

1. [基本] タブで、各設定に対して次の値を入力します。

    |  設定  |  値  |
    | ---- | ---- |
    |  **プロジェクトの詳細**  |
    |  サブスクリプション  |  ご自分のサブスクリプション  |
    |  リソース グループ   |  （新規）リソース グループ<br>　デフォルトでは、ShoeTracker_group となります。  |
    |  **インスタンスの詳細**  |
    |  ロジック アプリ名  |  ShoeTracker  |
    |  リージョン  |  最も近い場所をドロップダウン リストから選択します。  |
    |  プラン  |  消費  |
    

1. [確認と作成]、[作成] の順に選択します。 [デプロイ] ペインに、作成されたリソースが表示されます。 デプロイが正常に終了するまで待ちます。

## Azure Cosmos DB アカウントを作成する
では、トリガーを作成して、すべての必須パラメーターに値を指定してみましょう。

> **注意**
> Twitter アカウントを持っておらず、その作成を希望しない場合は、次のように置き換えます。 [検索] フィールドで "フィード項目が発行される場合" に置き換え、下部のボックスで "フィード項目が発行される場合" トリガーを選択します。 [RSS フィードの URL] を `https://twittersimulator.azurewebsites.net/api/feed/rss5` に、「選択したプロパティを使用して新しいアイテムを判断します。」 を `PublishDate` に、「項目を確認する頻度」を `1` に、[頻度] を `ヶ月` に設定します。 このアプローチの欠点は、まれに RSS フィードに新しい記事が表示されることがあるため、このトリガーをアクティブにする前にしばらく待つ必要があることです。

1. [コネクタとトリガーを検索] フィールドに「新しい Twitter が投稿されたら」と入力します。 下部のダイアログ ボックスで、Twitter の [新しいツイートが投稿されたら] を選択します。
1. [Twitter] ダイアログ ボックスでは、次の入力を求められます。

    |  設定  |  値  |
    | ---- | ---- |
    | [接続名] | ShoeTrackerTwitterConnection |
    | [Authentication Type] | 既定値 (Use default shared application) をそのまま使用します |

1. [サインイン] をクリックします。 ご自分がお持ちの Twitter アカウントとパスワードを使用してサインインし、[連携アプリを認証] を選択します。 この操作により、Twitter アカウントへのログイン接続が確立されます。
1. Twetter の [新しいツイートが投稿されたら] ダイアログ ボックスが再び表示されれば、有効な接続が作成されています。 ダイアログ ボックスには、3 つの必須パラメーターがあります。

    |  設定  |  値  |
    | ---- | ---- |
    | 検索テキスト | Shoe lang:ja exclude:retweets -filter:link |
    |  | （ご自身が気になる任意のキーワード） 日本語のみ、リツイート除外、リンクを除外| 
    | 項目を確認する頻度 | 1 |
    | (頻度) | 分 |
    | Add new parameter | 既定値 (空白) をそのまま使用します。 |

1. コマンド バーの [保存] を選択します。
1. [トリガーの実行] を選びます。

## Azure Cosmos DB データベースとコンテナーを作成する
この時点で、ロジック アプリによって 1 分間隔で検索テキストを含むツイートがあるかどうか、Twitter のスキャンが行われています。 アプリが実行されていて、正常に動作していることを確認するため、[実行の履歴] テーブルを調べます。

> **注意**
> 現在 Twitter コネクターの制限によりトリガー ポーリングの頻度が 1 時間に[制限](https://learn.microsoft.com/connectors/twitter/#limits)されています。短期間で複数回トリガーを実行するには、手動でトリガーを実行してください。

1. 左にスクロールし、ロジック アプリのメニューで [概要] を選択します。 ナビゲーション メニューを表示するには、左にスクロールすることが必要な場合があります。または、ブラウザーの検索機能を使用して、ページ上の "概要" という単語を検索することもできます。
1. [実行の履歴] テーブルに行が表示されるまで、1 分ごとに [更新] を選択します。
1. 待っている間に、[概要] で [トリガーの履歴] というラベルの付いたセクションを見つけます。 「過去 24 時間の実行数」と書かれているテキストに注目してください。毎分ポーリングしているため、この数は 1 分ごとに増加するはずです。このケースでは、この数はトリガーが一致するツイートを見つけた回数を表しています。
1. [実行の履歴] に戻ります。 行が表示されたら、その行を選択します。 行を選択すると、トリガーを作成するために使用したデザイナーのようなビューに移動します。 このビューでは、アプリのこの実行の各ステップを流れたデータを確認できます。
1. Twitter トリガーを選択します。
1. [出力] セクションでデータを調べます。 たとえば、一致するツイートのテキストを見つけます。

> **注意**
> JSON で応答の全体を表示する場合は、[未加工出力の表示] を選択します。


----

**[Home](./README.md)** 
